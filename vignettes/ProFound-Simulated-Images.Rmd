---
title: "ProFound: Testing on Simulated Images"
author: "Aaron Robotham"
date: "1 July 2017"
output: html_document
---



First of all we load **ProFit**. We also need to use **LaplacesDemon** because it gives us the Pareto (power-law) distribution that we will use to realistically sample our magnitude ranges later.

```{r}
library(ProFit)
library(LaplacesDemon)
```

Next we generate a random image with 200 stars and 200 extended sources. The value used roughly correspoond to the source densities and magnitude distributions you might expect to find in a Z-band VIKING frame (this was used to derive the image statistics).

```{r, fig.width=5, fig.height=5}
set.seed(664)

ExamplePSF=profitMakeGaussianPSF(fwhm=5)
ExamplePSF=ExamplePSF/sum(ExamplePSF)

Ngal=200
Nstar=200

model_test=list(
	sersic=list(
		xcen=runif(Ngal,0,1000),
		ycen=runif(Ngal,0,1000),
		mag=24-rpareto(Ngal,2),
		re=rpois(Ngal,5)+runif(Ngal),
		nser=runif(Ngal,1,4),
		ang=runif(Ngal,0,180),
		axrat=runif(Ngal,0.3,1),
		box=runif(Ngal,-0.3,0.3)
	),
	pointsource=list(
		xcen=runif(Nstar,0,1000),
		ycen=runif(Nstar,0,1000),
		mag=24-rpareto(Nstar,1.5)
	)
)

model_test$sersic$mag[model_test$sersic$mag<15]=runif(length(which(model_test$sersic$mag<15)),15,22)
model_test$pointsource$mag[model_test$pointsource$mag<15]=runif(length(which(model_test$pointsource$mag<15)),15,22)

im_test<-profitMakeModel(modellist=model_test, psf=ExamplePSF, dim=c(1000,1000), magzero = 30)$z
```

Next we add typical VIKING object shot-noise and sky noise:

```{r}
im_test=im_test+rnorm(1e6,sd=sqrt(im_test))
im_test=im_test+rnorm(1e6,sd=10)
```

And a handy plot:

```{r, fig.width=6, fig.height=6}
plot(sin)

magimage(im_test)

magimage(im_test)
points(model_test$sersic$xcen, model_test$sersic$ycen, col='yellow')
points(model_test$pointsource$xcen, model_test$pointsource$ycen, col='green')
```

Now we run ProFound with fairly standard settings (note we set the VIRCAM pixel scale):

```{r, fig.width=6, fig.height=6}
plot(sin)

magimage(im_test)

pro_test=profitProFound(im_test, magzero=30, skycut=1, pixcut=3, verbose=TRUE, plot=TRUE, boundstats=TRUE, pixscale=0.34, tolerance=2)
points(model_test$sersic$xcen, model_test$sersic$ycen, col='yellow')
points(model_test$pointsource$xcen, model_test$pointsource$ycen, col='green')
```

We can match back to our initial catalogue using coordmatch in **celestial**

```{r}
testmatch_gal=coordmatch(cbind(model_test$sersic$xcen,model_test$sersic$ycen)/3600, pro_test$segstats[,c("xcen","ycen")]/3600,5)

testmatch_stars=coordmatch(cbind(model_test$pointsource$xcen,model_test$pointsource$ycen)/3600,pro_test$segstats[,c("xcen","ycen")]/3600,5)
```

And plot the difference in estimated magnitude for the point sources (red) and extended sources (blue):

```{r}
magplot(model_test$sersic$mag[testmatch_gal$bestmatch$refID], model_test$sersic$mag[testmatch_gal$bestmatch$refID]-pro_test$segstats[testmatch_gal$bestmatch$compareID,'mag'], grid=TRUE, ylim=c(-1,1), col='blue')
points(pro_test$segstats$mag, pro_test$segstats$mag_err, pch='.')
points(pro_test$segstats$mag, -pro_test$segstats$mag_err, pch='.')

points(model_test$pointsource$mag[testmatch_stars$bestmatch$refID], model_test$pointsource$mag[testmatch_stars$bestmatch$refID]-pro_test$segstats[testmatch_stars$bestmatch$compareID,'mag'],col='red')
```

We can check how good our sky estimates were too:

```{r}
skyerror=sd(pro_test$sky)
maghist(pro_test$sky, breaks=100)
abline(v=c(-skyerror,0,skyerror), lty=c(3,2,3), col='red')

skyRMSerror=sd(pro_test$skyRMS)
maghist(pro_test$skyRMS, breaks=100)
abline(v=c(10-skyerror,10,10+skyerror), lty=c(3,2,3), col='red')
```

You can see there is a slight bias to a positive sky measurement- this is caused by the background of very faint currently undetected sources

Next we can make a new image where the detected objects are replaced with noise representing out estimated measurements:

```{r}
im_test_sub=im_test
im_test_sub[pro_test$objects_redo==1]=rnorm(length(which(pro_test$objects_redo==1)), mean=pro_test$sky[pro_test$objects_redo==1], sd=pro_test$skyRMS[pro_test$objects_redo==1])
```

And we can plot this:

```{r, fig.width=6, fig.height=6}
plot(sin)

magimage(pro_test$objects_redo)
points(model_test$sersic$xcen, model_test$sersic$ycen, col='yellow')
points(model_test$pointsource$xcen, model_test$pointsource$ycen, col='green')

magimage(im_test_sub)

magimage(im_test_sub)
points(model_test$sersic$xcen, model_test$sersic$ycen, col='yellow')
points(model_test$pointsource$xcen, model_test$pointsource$ycen, col='green')

magimage(profitImBlur(im_test_sub,5))

magimage(profitImBlur(im_test_sub,5))
points(model_test$sersic$xcen, model_test$sersic$ycen, col='yellow')
points(model_test$pointsource$xcen, model_test$pointsource$ycen, col='green')
```

The next step is to run **ProFound** again but pushing down to detect fainter objects. We use the sky and sky-RMS from the first run, and then mask out region that have known high surface brightness objects.

The important parameter now is the skycut. somewhere between 0.1 and 0.2 recovers the very faint objecst we have left- too low and we see a lot of false-positive contamination, too high and our true-positive rate drops. Setting it to 0.15 appears to be about the sweet spot (this would need testing on different depth data with realistic source distributions etc).

```{r, fig.width=6, fig.height=6}
plot(sin)

magimage(im_test)

pro_test_sub=profitProFound(image=im_test_sub, mask=pro_test$objects, sky=pro_test$sky, skyRMS=pro_test$skyRMS, magzero=30, skycut=0.15, pixcut=3, verbose=TRUE, plot=TRUE, boundstats=TRUE, pixscale=0.2, tolerance=2, sigma=5)
points(model_test$sersic$xcen, model_test$sersic$ycen, col='yellow',cex=0.5)
points(model_test$pointsource$xcen, model_test$pointsource$ycen, col='green',cex=0.5)
```

It is worth experimenting with the above, but it should be clear that with a few steps of detection of masking, very low surface brightness obects can be extracted with some confidence. To fully parameterise these faint objects a proper galaxy profile should be made using **ProFit**.

We can make a final image with all structure removed, sky subtracted and divided through by the RMS.

```{r}
im_test_fin=im_test_sub-pro_test_sub$sky
im_test_fin[pro_test_sub$objects_redo==1]=rnorm(length(which(pro_test_sub$objects_redo==1)), mean=0, sd=pro_test_sub$skyRMS[pro_test_sub$objects_redo==1])
im_test_fin=im_test_fin/pro_test_sub$skyRMS
```

To see whether we have removed (or subtracted out in the case of the sky) all structure we can use an FFT:

```{r, fig.width=6, fig.height=6}
centre=matrix(c(rep(c(-1,1),500), rep(c(1,-1),500)),1000,1000)

plot(sin)

magimage(Mod(fft(z=im_test*centre))); points(500,500,cex=5,col='red')

magimage(Mod(fft(z=im_test_sub*centre))); points(500,500,cex=5,col='red')

magimage(Mod(fft(z=im_test_fin*centre))); points(500,500,cex=5,col='red')

magimage(Mod(fft(z=matrix(rnorm(1e6, mean=0, sd=10), 1000)))); points(500,500,cex=5,col='red')
```

It should be clear that doing a few iterative steps of removing sources and analysing the FFT until there is little high to moderate frequency signal left is a route to blindly extracting sources. Note if you have correlated pixels you will always have a bright central portion which corresponds to the pixel correlation scale (usuaully a couple of pixels).