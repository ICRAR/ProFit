---
title: "ProFit: Found 2 Fit"
author: "Aaron Robotham"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{ProFit: Found 2 Fit}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

In this vignette we will demonstrate fitting in the most automated mode available in **ProFit**. This is very high level, but hopefully usefully so in many cases. Users who need finer level control should look at some of the other vignettes that break various phases we do automatically here into more manual and explicit steps.

Get the latest version of **ProFound** and **ProFit**:

```{r, eval=FALSE}
library(devtools)
install_github('asgr/ProFound')
install_github('ICRAR/ProFit')
```

Set global evaluate (basically TRUE for GitHub version and FALSE for CRAN):

```{r}
evalglobal = FALSE
```

First load the libraries we need:

```{r}
library(ProFit)
library(ProFound)
library(magicaxis)
```

Load the data:

```{r}
image=readFITS(system.file("extdata", 'VIKING/mystery_VIKING_Z.fits', package="ProFound"))$imDat
```

And take a look at what we have got:

```{r, fig.width=5, fig.height=5, dpi=40}
magimage(image, hicut=1)
```

It is Z-band data from the VIKING survey, and in the second image it is possible to see that the bright source close to our spiral galaxy of interest in the centre is in fact two very bright stars.

## Making an Automatic PSF

If we do not have a good model for the PSF, we can use the high level fairly automated function **profitAllStarDoFit** to find multiple reasonable stars within the frame (6 by default) and fit them all with a common Moffat model for our PSF. This takes about 7 minutes to run on a modern single CPU.

```{r eval=evalglobal, fig.width=8, fig.height=3, dpi=40}
stars_auto = profitAllStarDoFit(image, magzero=30, SBdilate=2)
```

And check the resulting fit:

```{r eval=evalglobal, fig.width=8, fig.height=5, dpi=40}
profitLikeModel(stars_auto$parm, stars_auto$Data, makeplots = TRUE, plotchisq = TRUE)
```

And we can look at the model PSF too:

```{r eval=evalglobal, fig.width=5, fig.height=5, dpi=40}
magimage(stars_auto$psf)
```

And look at the model parameters too (if you are interested):

```{r eval=evalglobal}
stars_auto$psf_modellist
```

## Fit a Galaxy

We can now attempt a fit of our target galaxy near the middle of the image. By default this is what is targeted by **profitDoFit**, but we will specify the *loc* explicitly to make the process clear. For the first example we will fit just a single Sersic component (the default). The function automatically detects nearby sources and models them a single Sersic profiles to reduce the contamination in our target source.

```{r eval=evalglobal}
example_SS = profitDoFit(image=image, loc=c(178,178), psf=stars_auto$psf, magzero=30,
                         SBdilate=2)
```

And check the resulting fit:

```{r eval=evalglobal, fig.width=8, fig.height=5, dpi=40}
profitLikeModel(example_SS$parm, example_SS$Data, makeplots = TRUE, plotchisq = TRUE)
```

We can try to improve the fit by doing a 2 component fit. By setting **Ncomp**=1.5 we will fit the bulge as an unresolved PSF:

```{r eval=evalglobal}
example_Bpsf = profitDoFit(image=image, loc=c(178,178), Ncomp=1.5, psf=stars_auto$psf,
                           magzero=30, SBdilate=2)
```

And check the resulting fit:

```{r eval=evalglobal, fig.width=8, fig.height=5, dpi=40}
profitLikeModel(example_Bpsf$parm, example_Bpsf$Data, makeplots = TRUE, plotchisq = TRUE)
```

We can try to improve the fit by doing a 2 component fit with a fixed Sersic n=4 bulge.

```{r eval=evalglobal}
example_B4 = profitDoFit(image=image, loc=c(178,178), Ncomp=2, psf=stars_auto$psf, magzero=30, 
                         SBdilate=2, bulge_nser_fit=FALSE)
```

And check the resulting fit:

```{r eval=evalglobal, fig.width=8, fig.height=5, dpi=40}
profitLikeModel(example_B4$parm, example_B4$Data, makeplots = TRUE, plotchisq = TRUE)
```
